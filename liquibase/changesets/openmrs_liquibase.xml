<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <changeSet author="vishnu" id = "create required sql functions">
        <sqlFile path="../sql_files/sql_functions.sql" endDelimiter="\nGO" stripComments="false" relativeToChangelogFile="true"/>
    </changeSet>

    <changeSet author="vishnu" id="add missing eventRecords for patients ">
        <preConditions onFail="MARK_RAN">
            <not>
                <sqlCheck expectedResult="0">
                    select count(*)
                    from patient
                    where date_created &lt; (select min(date_created) from event_records where category = 'patient');
                </sqlCheck>
            </not>
        </preConditions>
        <sql>
            INSERT INTO event_records(uuid,title,timestamp,object,uri,category,tags)
            select uuid(),'Patient',now(),CONCAT('/openmrs/ws/rest/v1/patient/',uuid, '?v=full'),NULL,'patient','patient'
            from person where date_created &lt; (select min(date_created) from event_records where category = 'patient');
        </sql>
    </changeSet>

    <changeSet author="vishnu" id="add missing eventRecords for programEnrolment">
        <preConditions onFail="MARK_RAN">
            <not>
                <sqlCheck expectedResult="0">
                    select count(*)
                    from patient_program
                    where date_created &lt; (select min(date_created) from event_records where category = 'programenrollment');
                </sqlCheck>
            </not>
        </preConditions>
        <sql>
            INSERT INTO event_records(uuid,title,timestamp,object,uri,category,tags)
            select uuid(),'Progam Enrollment',now(),CONCAT('/openmrs/ws/rest/v1/programenrollment/',uuid, '?v=full'),NULL,'programenrollment','programenrollment'
            from patient_program where date_created &lt; (select min(date_created) from event_records where category = 'programenrollment');
        </sql>
    </changeSet>

    <changeSet author="vishnu" id="add missing eventRecords for Encounter">
        <preConditions onFail="MARK_RAN">
            <not>
                <sqlCheck expectedResult="0">
                    select count(*)
                    from encounter
                    where date_created &lt; (select min(date_created) from event_records where category = 'Encounter');
                </sqlCheck>
            </not>
        </preConditions>
        <sql>
            INSERT INTO event_records(uuid,title,timestamp,object,uri,category,tags)
            select uuid(),'Encounter',now(),CONCAT('/openmrs/ws/rest/v1/bahmnicore/bahmniencounter/',uuid, '?v=full'),NULL,'Encounter','Encounter'
            from encounter where date_created &lt; (select min(date_created) from event_records where category = 'Encounter');
        </sql>
    </changeSet>

    <changeSet author="vishnu" id="add concept class for Facility">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                select count(*)
                from concept_class
                where name = 'Facility';
            </sqlCheck>
        </preConditions>
        <sql>
            insert into concept_class(name, description, creator, date_created, uuid)
            values('Facility', 'Facility field in forms', 1, now(), 'a027ba3d-3f61-4d2e-98d2-5dd0eac357d5');
        </sql>
    </changeSet>

    <changeSet author="vishnu" id="set Facility as concept class for all facility concepts">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="1">
                select count(*)
                from concept_class
                where name = 'Facility';
            </sqlCheck>
        </preConditions>
        <sql>
            update concept c inner join concept_name cn on c.concept_id = cn.concept_id and cn.name = 'Facility'
                set c.class_id = (select concept_class_id from concept_class where name = 'Facility');
        </sql>
    </changeSet>

    <changeSet author="vishnu" id="add concept class for District">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                select count(*)
                from concept_class
                where name = 'District';
            </sqlCheck>
        </preConditions>
        <sql>
            insert into concept_class(name, description, creator, date_created, uuid)
            values('District', 'District field in forms', 1, now(), 'e3564a79-84e0-4595-9868-1ba2f2ecda52');
        </sql>
    </changeSet>

    <changeSet author="vishnu" id="set District as concept class for all district concepts">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="1">
                select count(*)
                from concept_class
                where name = 'District';
            </sqlCheck>
        </preConditions>
        <sql>
            update concept c inner join concept_name cn on c.concept_id = cn.concept_id and cn.name = 'District'
                set c.class_id = (select concept_class_id from concept_class where name = 'District');
        </sql>
    </changeSet>

    <changeSet author="vishnu" id="add missing shortnames for all concepts for offline sync">
        <preConditions onFail="MARK_RAN">
            <not>
                <sqlCheck expectedResult="0">
                    select count(*) from concept_name
                    where concept_name_type = 'FULLY_SPECIFIED'
                    and concept_id not in (select concept_id from concept_name where concept_name_type = 'SHORT' and voided = 0);
                </sqlCheck>
            </not>
        </preConditions>
        <sql>
            insert into concept_name(uuid, concept_id, name, locale, creator, date_created, concept_name_type, voided)
            select uuid(), concept_id, name, 'en', 1, now(), 'SHORT', 0
            from concept_name where concept_name_type = 'FULLY_SPECIFIED'
            and concept_id not in (select concept_id from concept_name where concept_name_type = 'SHORT' and voided = 0);
        </sql>
    </changeSet>

    <changeSet author="vishnu" id="delete logs for removed concepts">
        <preConditions onFail="MARK_RAN">
            <not>
                <sqlCheck expectedResult="0">
                    select count(*) from event_log where category = 'offline-concepts' and (select count(*)
                    from concept where uuid = (select substr(object, 29, 36))) = 0;
                </sqlCheck>
            </not>
        </preConditions>
        <sql>
            delete from event_log where category = 'offline-concepts' and (select count(*)
            from concept where uuid = (select substr(object, 29, 36))) = 0;
        </sql>
    </changeSet>

    <changeSet author="vishnu" id="void synonyms for Yes concept">
        <preConditions onFail="MARK_RAN">
            <not>
                <sqlCheck expectedResult="0">
                    select count(*) from concept_name where concept_id = 2146 and concept_name_type is null and voided = 0;
                </sqlCheck>
            </not>
        </preConditions>
        <sql>
            update concept_name set voided = 1 where concept_id = 2146 and concept_name_type is null and voided = 0;
        </sql>
    </changeSet>

    <changeSet author="vishnu" id="void synonyms for No concept">
        <preConditions onFail="MARK_RAN">
            <not>
                <sqlCheck expectedResult="0">
                    select count(*) from concept_name where concept_id = 2147 and concept_name_type is null and voided = 0;
                </sqlCheck>
            </not>
        </preConditions>
        <sql>
            update concept_name set voided = 1 where concept_id = 2147 and concept_name_type is null and voided = 0;
        </sql>
    </changeSet>

    <changeSet author="vishnu" id="set filter as null for addressHierarchy event_logs">
        <sql>
            update event_log set filter = null where category = 'addressHierarchy';
        </sql>
    </changeSet>

    <changeSet author="vishnu" id="Update sync strategy from Selective to ID based.">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="1">
                select count(*) from global_property where property = 'bahmniOfflineSync.strategy';
            </sqlCheck>
        </preConditions>
        <sql>
            update global_property set property_value = 'org.bahmni.module.bahmniOfflineSync.strategy.IDBasedSyncStrategy' where property = 'bahmniOfflineSync.strategy';
        </sql>
    </changeSet>

    <changeSet author="vishnu" id="Create function to insert new forms">
        <sqlFile path="../sql_files/form_insert_function.sql" endDelimiter="\nGO" stripComments="false" relativeToChangelogFile="true"/>
    </changeSet>

    <changeSet author="vishnu" id="Insert newly edited forms and form resources">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                select count(*) from form where version > 1;
            </sqlCheck>
        </preConditions>
        <sql>
            select insert_form('ART Continuation', '1', '559a3d4d-55fb-4d40-9bc0-588e36827915');
            select insert_form('STI Diagnosis and Treatment', '1', 'f83f1721-3987-4f74-80e3-ab34447acbb2');
            select insert_form('TB Prevention and Treatment', '1', '058b40e3-b077-43ba-94c3-fe7709025ba3');
            select insert_form('ART Initiation', '1', '3a56449e-aa32-4a3e-88e1-bf303c889809');
            select insert_form('General Screening Form', '1', '68e384c1-450f-4a51-81f1-b71f47cdcbd6');

            select insert_form('Art initial Visit compulsory Question 2 of 2', '2', '308b1e40-06ff-4ae7-a6b6-84fa7b7beebd');
            select insert_form('STI Symptoms', '2', '7c14ed1f-c2eb-45f1-b086-40508127dc0d');
            select insert_form('General', '2', 'a2d643fe-e557-4aaf-aa37-ee85663e10b7');
            select insert_form('ART Observations', '2', 'c2ac0e33-3f7f-4391-89ff-0a813d6b860f');
            select insert_form('Assessment and Plan', '2', 'ace0685e-29a2-4b19-8052-bb6f2c4fb4b4');
            select insert_form('NCD', '2', '929a9c26-49c6-40a9-86bd-439cfacbce17');
            select insert_form('PrEP Screening Tool', '2', 'c2baa6ea-ef64-42d1-9e04-fe0c83ad8429');
            select insert_form('TB Screening and History', '2', 'b87accd1-2906-4284-aa02-0d1520dd3e68');
            select insert_form('Art initial Visit compulsory Question 1 of 2', '2', 'c77bba7e-79ed-4c75-8162-9c090b1c5676');
            select insert_form('HIV Self Testing', '2', '0a89eb93-2dd2-4dc6-b53a-f03fe083b32a');
            select insert_form('IPV Form', '2', 'b39cb14a-66f9-4222-ba1e-654bb1a6bf6d');
            select insert_form('PrEP Continuation', '2', 'f0d826c1-df5a-4500-91fc-61e520ff10f3');
            select insert_form('Provider HIV test counselling', '2', '19b38138-5344-4dec-9473-8f4377233c0e');
            select insert_form('VIAC Form', '2', '0e4ea5bc-d40c-4a72-9a54-01511fab8113');
            select insert_form('FP Counselling Only', '2', 'c539e19d-186a-4f61-a61b-a7ce742a62b1');
            select insert_form('Referrals Template', '2', '81588470-2cfb-4722-af44-a20ff3681f67');
            select insert_form('FP Continuation', '2', 'ba0b0df1-22f0-4f8a-8a38-6bbee6f12fbe');
            select insert_form('Family Planning Initial', '2', '9534b9b8-e68c-4930-8f4a-c9ac8bf72c72');
            select insert_form('PrEP Initial', '2', '2afd4f7a-8509-444c-a596-25310863a68a');
        </sql>
    </changeSet>

    <changeSet author="vishnu" id="delete existing form event_logs">
        <preConditions onFail="MARK_RAN">
            <not>
                <sqlCheck expectedResult="0">
                    select count(*) from event_log where category = 'forms';
                </sqlCheck>
            </not>
        </preConditions>
        <sql>
            delete from event_log where category = 'forms';
        </sql>
    </changeSet>

    <changeSet author="vishnu" id="delete existing form records from event_records">
        <preConditions onFail="MARK_RAN">
            <not>
                <sqlCheck expectedResult="0">
                    select count(*) from event_records where category = 'forms';
                </sqlCheck>
            </not>
        </preConditions>
        <sql>
            delete from event_records where category = 'forms';
        </sql>
    </changeSet>

    <changeSet author="vishnu" id="add event_records for forms">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                select count(*) from event_records where category = 'forms';
            </sqlCheck>
        </preConditions>
        <sql>
            insert into event_records(uuid, uri, object, category)
            select uuid(),  CONCAT('/openmrs/ws/rest/v1/form/' , uuid , '?v=custom:(resources:(value),name,version,uuid)'), CONCAT('/openmrs/ws/rest/v1/form/' , uuid , '?v=custom:(resources:(value),name,version,uuid)'), 'forms'
            from form order by version;
        </sql>
    </changeSet>

    <changeSet author="vishnu" id="add missing event_log for new forms">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                select count(*) from event_log where category = 'forms';
            </sqlCheck>
        </preConditions>
        <sql>
            insert into event_log(uuid, object, category)
            select uuid(), CONCAT('/openmrs/ws/rest/v1/form/' , uuid , '?v=custom:(resources:(value),name,version,uuid)'), 'forms'
            from form order by version;
        </sql>
    </changeSet>

    <changeSet id="PSI-CONFIG-2022061601" author="Rony">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT count(*) from person_attribute_type where name = 'Cluster Name';
            </sqlCheck>
        </preConditions>
        <comment>Add person attribute - cluster name</comment>
        <sql>
            insert into person_attribute_type ( name, description, format,creator, date_created,uuid) values("Cluster Name", "Cluster Name","java.lang.String",1, now(),"5e139545-8430-43ce-a172-40634107eab8");
        </sql>
    </changeSet>
    <changeSet id="PSI-CONFIG-2022061602" author="Rony">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="1">
                SELECT count(*) from person_attribute_type where name = 'email' and retired = false;
            </sqlCheck>
        </preConditions>
        <comment>Retire person attribute - email</comment>
        <sql>
            update person_attribute_type set retired = true, retired_by =4, retire_reason = "Replaced with cluster name", date_retired=now() where name = 'email';
        </sql>
    </changeSet>
    <changeSet author="rony" id="Add privilege bypassRetrospectiveDateThreshold">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                select count(*) from privilege where privilege = 'bypassRetrospectiveDateThreshold'
            </sqlCheck>
        </preConditions>
        <sql>
            insert into privilege(privilege,description,uuid) values('bypassRetrospectiveDateThreshold', 'Bypass retrospective data entry date threshold', 'ff914948-eb15-4a8a-8b5d-b0bf3df2b169')
        </sql>
    </changeSet>
    <changeSet author="rony" id="Add privilege allowDashboardFormsEditn">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                select count(*) from privilege where privilege = 'allowDashboardFormsEdit'
            </sqlCheck>
        </preConditions>
        <sql>
            insert into privilege(privilege,description,uuid) values('allowDashboardFormsEdit', 'Allow edit in dashboard forms', '2f460c90-23d1-41ee-86f3-ec9dd3c37f42')
        </sql>
    </changeSet>

    <changeSet author="vishnu" id = "update get_concept_name function">
        <sqlFile path="../sql_files/updated_get_concept_name.sql" endDelimiter="\nGO" stripComments="false" relativeToChangelogFile="true"/>
    </changeSet>
</databaseChangeLog>

