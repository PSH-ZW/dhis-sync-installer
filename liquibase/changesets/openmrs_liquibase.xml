<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <changeSet author="vishnu" id = "create required sql functions">
        <sqlFile path="../sql_files/sql_functions.sql" endDelimiter="\nGO" stripComments="false" relativeToChangelogFile="true"/>
    </changeSet>

    <changeSet author="vishnu" id="add missing eventRecords for patients ">
        <preConditions onFail="MARK_RAN">
            <not>
                <sqlCheck expectedResult="0">
                    select count(*)
                    from patient
                    where date_created &lt; (select min(date_created) from event_records where category = 'patient');
                </sqlCheck>
            </not>
        </preConditions>
        <sql>
            INSERT INTO event_records(uuid,title,timestamp,object,uri,category,tags)
            select uuid(),'Patient',now(),CONCAT('/openmrs/ws/rest/v1/patient/',uuid, '?v=full'),NULL,'patient','patient'
            from person where date_created &lt; (select min(date_created) from event_records where category = 'patient');
        </sql>
    </changeSet>

    <changeSet author="vishnu" id="add missing eventRecords for programEnrolment">
        <preConditions onFail="MARK_RAN">
            <not>
                <sqlCheck expectedResult="0">
                    select count(*)
                    from patient_program
                    where date_created &lt; (select min(date_created) from event_records where category = 'programenrollment');
                </sqlCheck>
            </not>
        </preConditions>
        <sql>
            INSERT INTO event_records(uuid,title,timestamp,object,uri,category,tags)
            select uuid(),'Progam Enrollment',now(),CONCAT('/openmrs/ws/rest/v1/programenrollment/',uuid, '?v=full'),NULL,'programenrollment','programenrollment'
            from patient_program where date_created &lt; (select min(date_created) from event_records where category = 'programenrollment');
        </sql>
    </changeSet>

    <changeSet author="vishnu" id="add missing eventRecords for Encounter">
        <preConditions onFail="MARK_RAN">
            <not>
                <sqlCheck expectedResult="0">
                    select count(*)
                    from encounter
                    where date_created &lt; (select min(date_created) from event_records where category = 'Encounter');
                </sqlCheck>
            </not>
        </preConditions>
        <sql>
            INSERT INTO event_records(uuid,title,timestamp,object,uri,category,tags)
            select uuid(),'Encounter',now(),CONCAT('/openmrs/ws/rest/v1/bahmnicore/bahmniencounter/',uuid, '?v=full'),NULL,'Encounter','Encounter'
            from encounter where date_created &lt; (select min(date_created) from event_records where category = 'Encounter');
        </sql>
    </changeSet>

    <changeSet author="vishnu" id="add concept class for Facility">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                select count(*)
                from concept_class
                where name = 'Facility';
            </sqlCheck>
        </preConditions>
        <sql>
            insert into concept_class(name, description, creator, date_created, uuid)
            values('Facility', 'Facility field in forms', 1, now(), 'a027ba3d-3f61-4d2e-98d2-5dd0eac357d5');
        </sql>
    </changeSet>

    <changeSet author="vishnu" id="set Facility as concept class for all facility concepts">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="1">
                select count(*)
                from concept_class
                where name = 'Facility';
            </sqlCheck>
        </preConditions>
        <sql>
            update concept c inner join concept_name cn on c.concept_id = cn.concept_id and cn.name = 'Facility'
                set c.class_id = (select concept_class_id from concept_class where name = 'Facility');
        </sql>
    </changeSet>

    <changeSet author="vishnu" id="add concept class for District">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                select count(*)
                from concept_class
                where name = 'District';
            </sqlCheck>
        </preConditions>
        <sql>
            insert into concept_class(name, description, creator, date_created, uuid)
            values('District', 'District field in forms', 1, now(), 'e3564a79-84e0-4595-9868-1ba2f2ecda52');
        </sql>
    </changeSet>

    <changeSet author="vishnu" id="set District as concept class for all district concepts">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="1">
                select count(*)
                from concept_class
                where name = 'District';
            </sqlCheck>
        </preConditions>
        <sql>
            update concept c inner join concept_name cn on c.concept_id = cn.concept_id and cn.name = 'District'
                set c.class_id = (select concept_class_id from concept_class where name = 'District');
        </sql>
    </changeSet>

    <changeSet author="vishnu" id="add missing shortnames for all offline concepts">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                select count(*) from concept_name
                where concept_name_type = 'FULLY_SPECIFIED'
                and concept_id not in (select concept_id from concept_name where concept_name_type = 'SHORT' and voided = 0);
            </sqlCheck>
        </preConditions>
        <sql>
            insert into concept_name(uuid, concept_id, name, locale, creator, date_created, concept_name_type, voided)
            select uuid(), concept_id, name, 'en', 1, now(), 'SHORT', 0
            from concept_name where concept_name_type = 'FULLY_SPECIFIED'
            and concept_id not in (select concept_id from concept_name where concept_name_type = 'SHORT' and voided = 0);
        </sql>
    </changeSet>

    <changeSet author="vishnu" id="add eventrecords for forms">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                select count(*) from event_records where category = 'forms';
            </sqlCheck>
        </preConditions>
        <sql>
            insert into event_records(uuid, uri, object, category)
            select uuid(),  CONCAT('/openmrs/ws/rest/v1/form/' , uuid , '?v=custom:(resources:(value),name,version,uuid)'), CONCAT('/openmrs/ws/rest/v1/form/' , uuid , '?v=custom:(resources:(value),name,version,uuid)'), 'forms'
            from form order by version;
        </sql>
    </changeSet>

    <changeSet author="vishnu" id="add missing event_log for forms">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                select count(*) from event_log where category = 'forms';
            </sqlCheck>
        </preConditions>
        <sql>
            insert into event_log(uuid, object, category)
            select uuid(), CONCAT('/openmrs/ws/rest/v1/form/' , uuid , '?v=custom:(resources:(value),name,version,uuid)'), 'forms'
            from form order by version;
        </sql>
    </changeSet>

    <changeSet author="vishnu" id="delete logs for removed concepts">
        <preConditions onFail="MARK_RAN">
            <not>
                <sqlCheck expectedResult="0">
                    select count(*) from event_log where category = 'offline-concepts' and (select count(*)
                    from concept where uuid = (select substr(object, 29, 36))) = 0;
                </sqlCheck>
            </not>
        </preConditions>
        <sql>
            delete from event_log where category = 'offline-concepts' and (select count(*)
            from concept where uuid = (select substr(object, 29, 36))) = 0;
        </sql>
    </changeSet>

    <changeSet author="vishnu" id="void synonyms for Yes concept">
        <preConditions onFail="MARK_RAN">
            <not>
                <sqlCheck expectedResult="0">
                    select count(*) from concept_name where concept_id = 2146 and concept_name_type is null and voided = 0;
                </sqlCheck>
            </not>
        </preConditions>
        <sql>
            update concept_name set voided = 1 where concept_id = 2146 and concept_name_type is null and voided = 0;
        </sql>
    </changeSet>

    <changeSet author="vishnu" id="void synonyms for No concept">
        <preConditions onFail="MARK_RAN">
            <not>
                <sqlCheck expectedResult="0">
                    select count(*) from concept_name where concept_id = 2147 and concept_name_type is null and voided = 0;
                </sqlCheck>
            </not>
        </preConditions>
        <sql>
            update concept_name set voided = 1 where concept_id = 2147 and concept_name_type is null and voided = 0;
        </sql>
    </changeSet>

    <changeSet author="vishnu" id="set filter as null for addressHierarchy event_logs">
        <sql>
            update event_log set filter = null where category = 'addressHierarchy';
        </sql>
    </changeSet>

</databaseChangeLog>

